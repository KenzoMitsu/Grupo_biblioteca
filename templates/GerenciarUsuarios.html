<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabela de Usuários</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+JP:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../static/dist/assets/owl.carousel.min.css">
  <link rel="stylesheet" href="../static/dist/assets/owl.theme.default.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../static/css/usuarios.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="../static/js/scripts.js"></script>
  <script src="../static/js/seguranca.js" defer></script>
  <script src="../static/js/segurancaBiblio.js" defer></script>

  <script src="../static/js/paginaip.js"></script>

  <link rel="stylesheet" href="../static/css/usuarios.css" />
  <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">
</head>


<body>
  <header>
    <!-- Logo -->
    <div class="header-left">
      <a id="logoHeader" href="home.html"><img src="http://192.168.1.125:5000/static/uploads/logo/logo.png" alt="Logo"></a>
    </div>

    <!-- Barra de Pesquisa -->
    <form id="formBuscaLivro">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="campoBusca" placeholder="Pesquisar Usuario" class="search-box">
      </div>
    </form>

    <div class="coisa">
      <!-- Ícone de Menu com Dropdown -->
      <div class="header-end">
        <div class="menu-container">
          <div class="menu-icon" id="menuButton">
            <div class="menulinha"></div>
            <div class="menulinha"></div>
            <div class="menulinha"></div>
          </div>

          <ul class="dropdown-menu" id="dropdownMenu">

          </ul>

        </div>
      </div>

  </header>
  <!-- FIM DO CABEÇALHO -->

  <div class="container">
    <div class="texto">
      <h2 class="titulo">Gerenciar Usuário</h2>
    </div>

    <div class="addusuario">
      <button id="btn-adicionar-usuario" class="btn2">
        <i class="fa fa-user-plus"></i> Adicionar Usuário
      </button>
    </div>
  </div>

  <div class="table-container">
    <table class="tabela-container" id="tabela-usuarios" border="3">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>Nascimento</th>
          <th>Cargo</th>
          <th>Status</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="paginacao">

      <a href="" class="btn" id="pagina-anterior"> <i class="fa-solid fa-left-long"></i> </a>
      <h3 class="paginaAtual" id="paginaAtual">Página Atual</h3>
      <a href="" class="btn" id="pagina-proxima"> <i class="fa-solid fa-right-long"></i> </a>
    </div>
  </div>

  <!-- Modal para Adição de Usuário -->
  <div id="modal-adicao">
    <form id="form-adicao">
      <h3>Adicionar Novo Usuário</h3>

      <label for="nome_adicao">Nome:</label>
      <input type="text" id="nome_adicao" required>

      <label for="email_adicao">Email:</label>
      <input type="email" id="email_adicao" required>

      <label for="senha_adicao">Senha:</label>
      <input type="password" id="senha_adicao" required>


      <label for="telefone_adicao">Telefone:</label>
      <input type="text" id="telefone_adicao" onkeyup="handlePhone(event)" required>

      <label for="data_nascimento_adicao">Data de nascimento:</label>
      <input type="date" id="data_nascimento_adicao" required>

      <label for="cargo_adicao">Cargo:</label>
      <select name="cargo_adicao" id="cargo_adicao">
        <option value="Cliente">Cliente</option>
        <option value="Bibliotecário">Bibliotecário</option>
        <option value="ADM">ADM</option>
      </select>

      <label for="status_adicao">Status:</label>
      <select name="status_adicao" id="status_adicao">
        <option value="Ativo">Ativo</option>
        <option value="Inativo">Inativo</option>
      </select>

      <div class="modal-buttons">
        <button type="submit" class="enviar">Adicionar</button>
        <button type="button" id="fechar-modal-adicao">Cancelar</button>
      </div>
    </form>
  </div>

  <footer class="inter">
    <div class="separacao1">
      <p>Entre em contato conosco</p>
      <div class="redes">
        <a href="https://www.whatsapp.com/?lang=pt_BR">
          <i class="fa-brands fa-whatsapp"></i>
        </a>
        <a href="https://www.instagram.com">
          <i class="fa-brands fa-instagram"></i>
        </a>
        <a href="https://br.linkedin.com">
          <i class="fa-brands fa-linkedin"></i>
        </a>
        <a href="https://x.com/?lang=pt">
          <i class="fa-brands fa-twitter"></i>
        </a>
        <a href="https://pt-br.facebook.com/login/device-based/regular/login/">
          <i class="fa-brands fa-facebook"></i>
        </a>
      </div>
    </div>
    <div class="rodape-inter">
      <div class="informacao">
        <p class="informacoes">INFORMAÇÕES</p>
        <div class="linha"></div>
        <div class="display">
          <i class="fa-solid fa-envelope icons"></i>
          <p class="text">asa.literaria@email.com</p>
        </div>
        <div class="display">
          <i class="fa-solid fa-phone icons"></i>
          <p class="text">(18)99999-9999</p>
        </div>
      </div>
      <div class="imagem">
        <img class="logo_rodape" src="../static/img/logo.png" alt="logo">
      </div>

      <div class="localizacao">
        <p class="local">LOCALIZAÇÃO
          <br>
          Birigui - SP
        </p>
      </div>
    </div>

    <div class="as">
      <a href="https://www.google.com.br/?hl=pt-BR" class="text2">Termos de Uso</a>
      <a href="https://www.google.com.br/?hl=pt-BR" class="text2">Política de privacidade</a>
    </div>
  </footer>

  <script>

    function validarEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    $(document).ready(function () {
      const token = localStorage.getItem("token");

      carregarUsuarios();

      $("#btn-adicionar-usuario").click(function () {
        $("#modal-adicao").addClass("ativo");
      });

      $("#fechar-modal-adicao").click(function () {
        $("#modal-adicao").removeClass("ativo");
      });

      // Submissão do formulário de adição
      $("#form-adicao").submit(function (e) {
        e.preventDefault();

        const novoUsuario = {
          nome: $("#nome_adicao").val().trim(),
          email: $("#email_adicao").val().trim(),
          senha: $("#senha_adicao").val().trim(), // <- ESSENCIAL
          telefone: $("#telefone_adicao").val().trim(),
          data_nascimento: $("#data_nascimento_adicao").val(),
          cargo: $("#cargo_adicao").val(),
          status: $("#status_adicao").val()
        };

        $.ajax({
          method: "POST",
          url: ipPython + "/usuariosadm",
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          data: JSON.stringify(novoUsuario),
          success: function () {
            Swal.fire({
              title: "Sucesso!",
              text: "Usuário adicionado com sucesso.",
              icon: "success"
            });
            $("#modal-adicao").hide();
            $("#form-adicao")[0].reset();
            carregarUsuarios();
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error || "Erro ao adicionar usuário.",
              icon: "error"
            });
          }
        });
      });

      function carregarUsuarios() {
        const params = new URLSearchParams(window.location.search);
        var pagina = params.get('pagina');

        if (!pagina) pagina = 1;

        if (pagina == 1) {
          document.getElementById('pagina-anterior').style.display = "none";
        }

        $.ajax({
          method: "GET",
          url: ipPython + "/usuario?pagina=" + pagina,
          headers: {
            'Authorization': 'Bearer ' + token
          },
          success: function (data) {
            var total = data.total_paginas
            var paginaAtual = data.pagina_atual
            var anterior = paginaAtual - 1
            var proxima = paginaAtual + 1

            document.getElementById("pagina-anterior").href = "/templates/GerenciarUsuarios.html?pagina=" + anterior

            document.getElementById("pagina-proxima").href = "/templates/GerenciarUsuarios.html?pagina=" + proxima

            if (paginaAtual >= total) {
              document.getElementById('pagina-proxima').style.display = "none"
            }

            if (paginaAtual > total) {
              document.getElementById('listaLivros').innerHTML = `
                    <p>Usuários não encontrados!</p>
                `;
            }

            document.getElementById("paginaAtual").innerHTML = paginaAtual

            let usuarios = data.usuarios;
            let tabela = $("#tabela-usuarios tbody");
            tabela.empty();

            if (usuarios.length === 0) {
              tabela.append(`<tr><td colspan="8">Usuários não encontrados!</td></tr>`);
              return;
            }

            usuarios.forEach(usuario => {
              let linha = `
                <tr>
                  <td>${usuario.nome}</td>
                  <td>${usuario.email}</td>
                  <td class="tel">${usuario.telefone}</td>
                  <td>${formatarData(usuario.data_nascimento)}</td>
                  <td>${usuario.cargo}</td>
                  <td>${usuario.status}</td>
                  <td>
                    <a href="detalhesUsuario.html?id=${usuario.id_usuario}">
                      <button class="detalhes-btn">Detalhes</button>
                    </a>
                  </td>
                </tr>
              `;
              tabela.append(linha);
            });


            $(".editar-btn").click(function () {
              let id = $(this).data("id");
              let nome = $(this).data("nome");
              let email = $(this).data("email");
              let telefone = $(this).data("telefone");
              let data_nascimento_raw = $(this).data("data_nascimento");
              let data_nascimento = new Date(data_nascimento_raw).toISOString().split("T")[0];
              let cargo = $(this).data("cargo");
              let status = $(this).data("status");

              $("#id_usuario").val(id);
              $("#nome").val(nome);
              $("#email").val(email);
              $("#telefone").val(telefone);
              $("#data_nascimento").val(data_nascimento);
              $("#cargo").val(cargo);
              $("#status").val(status);

              $("#modal-edicao").show();
            });

            $(".excluir-btn").click(function () {
              const id = $(this).data("id");

              Swal.fire({
                title: 'Tem certeza?',
                text: "Essa ação não poderá ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
              }).then((result) => {
                if (result.isConfirmed) {
                  $.ajax({
                    method: "DELETE",
                    url: ipPython + "/usuariosadm/" + id,
                    headers: {
                      'Authorization': 'Bearer ' + token
                    },
                    success: function () {
                      Swal.fire({
                        title: "Excluído!",
                        text: "O usuário foi excluído com sucesso.",
                        icon: "success"
                      });
                      carregarUsuarios();
                    },
                    error: function (retorno) {
                      Swal.fire({
                        title: "Erro!",
                        text: JSON.parse(retorno.responseText).error || "Não foi possível excluir o usuário.",
                        icon: "error"
                      });
                    }
                  });
                }
              });
            });
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error,
              icon: "error"
            });
          }
        });
      }

      // Envio do formulário de edição
      $("#form-edicao").submit(function (e) {
        e.preventDefault();

        let id = $("#id_usuario").val();
        let nome = $("#nome").val().trim();
        let email = $("#email").val().trim();
        let telefone = $("#telefone").val().trim();
        let data_nascimento = $("#data_nascimento").val().trim();
        let cargo = $("#cargo").val().trim();
        let status = $("#status").val().trim();

        $.ajax({
          method: "PUT",
          url: ipPython + "/usuariosadm/" + id,
          headers: {
            'Authorization': 'Bearer ' + token
          },
          data: JSON.stringify({
            nome: nome,
            email: email,
            telefone: telefone,
            data_nascimento: data_nascimento,
            cargo: cargo,
            status: status
          }),
          contentType: "application/json",
          success: function () {
            Swal.fire({
              title: "Sucesso!",
              text: "Usuário atualizado com sucesso!",
              icon: "success"
            });
            $("#modal-edicao").hide();
            carregarUsuarios();
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error || "Falha ao editar usuário.",
              icon: "error"
            });
          }
        });
      });

      $("#fechar-modal").click(function () {
        $("#modal-edicao").hide();
      });

      $("#telefone, #telefone_adicao").on("keyup", function (event) {
        handlePhone(event);
      });

      const handlePhone = (event) => {
        let input = event.target;
        input.value = phoneMask(input.value);
      };

      const phoneMask = (value) => {
        if (!value) return "";
        value = value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, "($1) $2");
        value = value.replace(/(\d)(\d{4})$/, "$1-$2");
        return value;
      };

      function formatarData(dataISO) {
        if (!dataISO) return "";
        let data = new Date(dataISO);
        data.setDate(data.getDate() + 1);
        let dia = data.getDate().toString().padStart(2, "0");
        let mes = (data.getMonth() + 1).toString().padStart(2, "0");
        let ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }
    });

    function abrirModal(id) {
      document.getElementById('modal-' + id).style.display = 'block';
    }

    function fecharModal(id) {
      document.getElementById('modal-' + id).style.display = 'none';
    }

    window.onclick = function (event) {
      const modais = document.querySelectorAll('.modal');
      modais.forEach(modal => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const relatoriosItem = document.getElementById('relatorios');
      const submenu = relatoriosItem.querySelector('.submenu');
      relatoriosItem.querySelector('.submenu-toggle').addEventListener('click', function () {
        submenu.classList.toggle('show');
      });
    });

    function atualizarLinksRelatorios() {
      const linksRelatorios = {
        relatorioMultas: "/multas_relatorio",
        relatorioLivros: "/livros_relatorio",
        relatorioUsuarios: "/usuarios_relatorio",
        relatorioEmprestimos: "/emprestimos_relatorio"
      };
      for (let id in linksRelatorios) {
        const elemento = document.getElementById(id);
        if (elemento) {
          elemento.href = `${ipPython2}${linksRelatorios[id]}`;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", atualizarLinksRelatorios);

  </script>

</body>
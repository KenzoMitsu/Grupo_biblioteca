<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabela de Usuários</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+JP:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../static/dist/assets/owl.carousel.min.css">
  <link rel="stylesheet" href="../static/dist/assets/owl.theme.default.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../static/css/usuarios.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="../static/js/scripts.js"></script>
  <script src="../static/js/seguranca.js" defer></script>
  <script src="../static/js/segurancaADM.js" defer></script>

  <script src="../static/js/paginaip.js"></script>

  <link rel="stylesheet" href="../static/css/usuarios.css" />
  <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">
</head>

<body>
  <header>
    <!-- Logo -->
    <div class="header-left">
      <a id="logoHeader" href="home.html"><img src="../static/img/logo.png" alt="Logo"></a>
    </div>

    <!-- Barra de Pesquisa -->
    <div class="header-center">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Pesquise Seu Livro" class="search-box">
      </div>
    </div>

    <!-- Dark Mode -->


    <!-- Ícone de Menu com Dropdown -->
    <div class="header-end">
      <div class="menu-container">
        <div class="menu-icon" id="menuButton">
          <div class="menulinha"></div>
          <div class="menulinha"></div>
          <div class="menulinha"></div>
        </div>

        <ul class="dropdown-menu" id="dropdownMenu">

          <li class="menu-item"><i class="fa-solid fa-circle-user"></i><a id="editPerfil" href="editPerfil.html">
              Perfil</a>
          </li>

          <div id="cliente">
            <li class="menu-item"><i class="fas fa-book"></i><a href="reservas_atuais.html">Empréstimos</a></li>
            <li class="menu-item"><i class="fas fa-sync-alt"></i><a href="historico.html">Histórico</a></li>
          </div>



          <div id="adm">

            <li class="menu-item"><i class="fas fa-user"></i><a href="GerenciarUsuarios.html"> Gerenciar
                Usuários</a></li>

            <li class="menu-item"><i class="fa-solid fa-file-export"></i><a href="relatorios.html">Relatórios</li></a>

            <li class="menu-item"><i class="fa-solid fa-cash-register"></i><a href="multas.html">Gerenciar Multas</li>
            </a>

            <li class="menu-item"><i class="fas fa-book"></i><a href="editLivros.html">Gerenciar Livros
            </li></a>

            <li class="menu-item"><i class="fas fa-sync-alt"></i><a href="ListagemReservas.html">Reservas
            </li></a>

          </div>

          <div id="biblio">
            <li class="menu-item"><i class="fas fa-book"></i><a href="ListagemReservas.html">
                Reservas</a></li>

            <li class="menu-item"><i class="fa-solid fa-file-export"></i><a href="relatorios.html">Relatórios</a></li>

            <li class="menu-item"><i class="fas fa-sync-alt"></i><a href="editLivros.html"> Gerenciar
                Livros</a></li>
          </div>

          <li class="menu-item"><i class="fas fa-sign-out-alt"></i><button class="sair ">Sair</button>
          </li>
        </ul>

      </div>
    </div>
  </header>
  <!-- FIM DO CABEÇALHO -->

  <div class="container">
    <h2 class="titulo">Gerenciar Usuários</h2>
    <div class="adicionar-usuario">
      <a href="addUsuario.html" class="btn btn-primary">Adicionar Usuário</a>
    </div>

    <div class="table-container">
      <table class="tabela-container" id="tabela-usuarios" border="3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Nascimento</th>
            <th>Cargo</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal para Edição -->
    <div id="modal-edicao" style="display: none;">
      <form id="form-edicao">
        <input type="hidden" id="id_usuario">

        <label>Nome:</label>
        <input type="text" id="nome" required>

        <label>Email:</label>
        <input type="email" id="email" required>

        <label>Telefone:</label>
        <input type="text" id="telefone" onkeyup="handlePhone(event)" required>

        <label>Data de nascimento:</label>
        <input type="date" id="data_nascimento" required>


        <label for="cargo" class="coisa">Cargo:</label>
        <select class="inserir" name="cargo" id="cargo">
          <option class="inserir" value="Cliente">Cliente</option>
          <option class="inserir" value="Bibliotecário">Bibliotecário</option>
          <option class="inserir" value="ADM">ADM</option>
        </select>

        <label for="status" class="coisa">Status:</label>
        <select class="inserir" name="status" id="status">
          <option class="inserir" value="Ativo">Ativo</option>
          <option class="inserir" value="Inativo">Inativo</option>
        </select>

        <button type="submit">Salvar</button>
        <button type="button" id="fechar-modal">Cancelar</button>
      </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="usuarios.js"></script>



    <script>
      $(document).ready(function () {
        const token = localStorage.getItem("token");

        carregarUsuarios();

        function carregarUsuarios() {
          $.ajax({
            method: "GET",
            url: ipPython + "/usuario",
            headers: {
              'Authorization': 'Bearer ' + token
            },
            success: function (data) {
              let usuarios = data.usuarios_cadastrados;
              let tabela = $("#tabela-usuarios tbody");
              tabela.empty();

              usuarios.forEach(usuario => {
                let linha = `
                <tr>
                  <td>${usuario.id_usuario}</td>
                  <td>${usuario.nome}</td>
                  <td>${usuario.email}</td>
                  <td class="tel">${usuario.telefone}</td>
                  <td>${formatarData(usuario.data_nascimento)}</td>
                  <td>${usuario.cargo}</td>
                  <td>${usuario.status}</td>
                  <td>
                    <button class="editar-btn"
                      data-id="${usuario.id_usuario}"
                      data-nome="${usuario.nome}"
                      data-email="${usuario.email}"
                      data-telefone="${usuario.telefone}"
                      data-data_nascimento="${usuario.data_nascimento}"
                      data-cargo="${usuario.cargo}"
                      data-status="${usuario.status}">
                        Editar
                    </button>
                    <a href="historicoUsuario.html?id=${usuario.id_usuario}"><button class='botao-historico'>Histórico</button></a>
                    <a href="multarUsuario.html?id=${usuario.id_usuario}"><button class='botao-multas'>Multas</button></a>
                    <button class="excluir-btn" data-id="${usuario.id_usuario}">Excluir</button>
                    </td>
                </tr>
              `;
                tabela.append(linha);
              });

              // Evento de editar
              $(".editar-btn").click(function () {
                let id = $(this).data("id");
                let nome = $(this).data("nome");
                let email = $(this).data("email");
                let telefone = $(this).data("telefone");
                let data_nascimento_raw = $(this).data("data_nascimento");
                let data_nascimento = new Date(data_nascimento_raw).toISOString().split("T")[0];
                let cargo = $(this).data("cargo");
                let status = $(this).data("status");

                $("#id_usuario").val(id);
                $("#nome").val(nome);
                $("#email").val(email);
                $("#telefone").val(telefone);
                $("#data_nascimento").val(data_nascimento);
                $("#cargo").val(cargo);
                $("#status").val(status);

                $("#modal-edicao").show();
              });

              // Evento de excluir (dentro do carregamento para capturar os novos elementos)
              $(".excluir-btn").click(function () {
                const id = $(this).data("id");

                Swal.fire({
                  title: 'Tem certeza?',
                  text: "Essa ação não poderá ser desfeita!",
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#d33',
                  cancelButtonColor: '#3085d6',
                  confirmButtonText: 'Sim, excluir!',
                  cancelButtonText: 'Cancelar'
                }).then((result) => {
                  if (result.isConfirmed) {
                    $.ajax({
                      method: "DELETE",
                      url: ipPython + "/usuariosadm/" + id,
                      headers: {
                        'Authorization': 'Bearer ' + token
                      },
                      success: function () {
                        Swal.fire({
                          title: "Excluído!",
                          text: "O usuário foi excluído com sucesso.",
                          icon: "success"
                        });
                        carregarUsuarios();
                      },
                      error: function (retorno) {
                        Swal.fire({
                          title: "Erro!",
                          text: JSON.parse(retorno.responseText).error || "Não foi possível excluir o usuário.",
                          icon: "error"
                        });
                      }
                    });
                  }
                });
              });
            },
            error: function (retorno) {
              Swal.fire({
                title: "Erro!",
                text: JSON.parse(retorno.responseText).error || "Falha ao carregar usuários.",
                icon: "error"
              });
            }
          });
        }

        // Envio do formulário de edição
        $("#form-edicao").submit(function (e) {
          e.preventDefault();

          let id = $("#id_usuario").val();
          let nome = $("#nome").val().trim();
          let email = $("#email").val().trim();
          let telefone = $("#telefone").val().trim();
          let data_nascimento = $("#data_nascimento").val().trim();
          let cargo = $("#cargo").val().trim();
          let status = $("#status").val().trim();

          $.ajax({
            method: "PUT",
            url: ipPython + "/usuariosadm/" + id,
            headers: {
              'Authorization': 'Bearer ' + token
            },
            data: JSON.stringify({
              nome: nome,
              email: email,
              telefone: telefone,
              data_nascimento: data_nascimento,
              cargo: cargo,
              status: status
            }),
            contentType: "application/json",
            success: function () {
              Swal.fire({
                title: "Sucesso!",
                text: "Usuário atualizado com sucesso!",
                icon: "success"
              });
              $("#modal-edicao").hide();
              carregarUsuarios();
            },
            error: function (retorno) {
              Swal.fire({
                title: "Erro!",
                text: JSON.parse(retorno.responseText).error || "Falha ao editar usuário.",
                icon: "error"
              });
            }
          });
        });

        // Botão para fechar o modal
        $("#fechar-modal").click(function () {
          $("#modal-edicao").hide();
        });

        // Máscara de telefone
        $("#telefone").on("keyup", function (event) {
          handlePhone(event);
        });

        const handlePhone = (event) => {
          let input = event.target;
          input.value = phoneMask(input.value);
        };

        const phoneMask = (value) => {
          if (!value) return "";
          value = value.replace(/\D/g, '');
          value = value.replace(/(\d{2})(\d)/, "($1) $2");
          value = value.replace(/(\d)(\d{4})$/, "$1-$2");
          return value;
        };

        function formatarData(dataISO) {
          if (!dataISO) return "";

          let data = new Date(dataISO);
          data.setDate(data.getDate() + 1);

          let dia = data.getDate().toString().padStart(2, "0");
          let mes = (data.getMonth() + 1).toString().padStart(2, "0");
          let ano = data.getFullYear();

          return `${dia}/${mes}/${ano}`;
        }

        // Logout
        $(".sair").click(function () {
          localStorage.clear();
          window.location.href = "login.html";
        });
      });


    </script>

  </div>

  <footer class="inter">
    <div class="separacao1">
      <p>Entre em contato conosco</p>
      <div class="redes">
        <a href="https://www.whatsapp.com/?lang=pt_BR">
          <i class="fa-brands fa-whatsapp"></i>
        </a>
        <a href="https://www.instagram.com">
          <i class="fa-brands fa-instagram"></i>
        </a>
        <a href="https://br.linkedin.com">
          <i class="fa-brands fa-linkedin"></i>
        </a>
        <a href="https://x.com/?lang=pt">
          <i class="fa-brands fa-twitter"></i>
        </a>
        <a href="https://pt-br.facebook.com/login/device-based/regular/login/">
          <i class="fa-brands fa-facebook"></i>
        </a>
      </div>
    </div>
    <div class="rodape-inter">
      <div class="informacao">
        <p class="informacoes">INFORMAÇÕES</p>
        <div class="linha"></div>
        <div class="display">
          <i class="fa-solid fa-envelope icons"></i>
          <p class="text">asa.literaria@email.com</p>
        </div>
        <div class="display">
          <i class="fa-solid fa-phone icons"></i>
          <p class="text">(18)99999-9999</p>
        </div>
      </div>
      <div class="imagem">
        <img class="logo_rodape" src="../static/img/logo.png" alt="logo">
      </div>

      <div class="localizacao">
        <p class="local">LOCALIZAÇÃO
          <br>
          Birigui - SP
        </p>
      </div>
    </div>

    <div class="as">
      <a href="https://www.google.com.br/?hl=pt-BR" class="text2">Termos de Uso</a>
      <a href="https://www.google.com.br/?hl=pt-BR" class="text2">Política de privacidade</a>
    </div>
  </footer>

</body>

</html>
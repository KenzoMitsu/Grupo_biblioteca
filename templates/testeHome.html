<!DOCTYPE html> <html lang="pt-br"> <head> <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Avaliações</title> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" /> <style> .star { cursor: pointer; font-size: 2rem; color: #ddd; transition: color 0.2s; } .star.filled { color: #ffc107; } .review-card { border-left: 3px solid #0d6efd; padding-left: 10px; margin-bottom: 15px; } </style> </head> <body> <div class="container py-4"> <!-- Formulário de Avaliação --> <div class="card mb-4"> <div class="card-body"> <h5 class="card-title">Avalie este livro</h5> <div class="mb-3"> <span class="star" data-value="1">★</span> <span class="star" data-value="2">★</span> <span class="star" data-value="3">★</span> <span class="star" data-value="4">★</span> <span class="star" data-value="5">★</span> </div> <textarea id="comment" class="form-control mb-3" placeholder="Seu comentário..." rows="3"></textarea> <button id="submitReview" class="btn btn-primary">Enviar</button> </div> </div>
    <!-- Lista de Avaliações -->
    <div id="reviewsContainer" class="mt-4">
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE_URL = "http://192.168.1.109:5000"; // atualize para a URL correta da sua API
    const livroId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem('token');

    const stars = document.querySelectorAll('.star');
    const commentInput = document.getElementById('comment');
    const submitBtn = document.getElementById('submitReview');
    const reviewsContainer = document.getElementById('reviewsContainer');
    let selectedRating = 0;

    // Atualiza a visualização das estrelas baseando-se no rating selecionado
    function updateStars() {
        stars.forEach(star => {
            const value = parseInt(star.getAttribute('data-value'));
            star.classList.toggle('filled', value <= selectedRating);
        });
    }

    // Seta eventos nas estrelas para capturar interação de usuário
    function setupStarRating() {
        stars.forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.getAttribute('data-value'));
                updateStars();
            });
            star.addEventListener('mouseover', () => {
                let hoverValue = parseInt(star.getAttribute('data-value'));
                stars.forEach(s => s.classList.toggle('filled', parseInt(s.getAttribute('data-value')) <= hoverValue));
            });
            star.addEventListener('mouseout', () => {
                updateStars();
            });
        });
    }

    // Exibe mensagens de erro no container de avaliações
    function showError(message) {
        reviewsContainer.innerHTML = `
            <div class="alert alert-danger">
                ${message}
                <button onclick="window.location.reload()" class="btn btn-sm btn-outline-danger ms-2">
                    Recarregar
                </button>
            </div>
        `;
    }

    // Carrega as avaliações da API e exibe
    async function loadReviews() {
        try {
            // Mostra spinner enquanto carrega
            reviewsContainer.innerHTML = `
                <div class="d-flex justify-content-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            `;

            const response = await fetch(`${API_BASE_URL}/avaliacoes/${livroId}`, {
                headers: {
                    'Authorization': token || ''
                }
            });

            if (!response.ok) {
                throw new Error('Erro ao carregar avaliações');
            }

            const data = await response.json();

            displayReviews(data.avaliacoes || []);
        } catch (error) {
            showError(error.message);
        }
    }

    // Exibe as avaliações na página
    function displayReviews(reviews) {
        if (reviews.length === 0) {
            reviewsContainer.innerHTML = '<div class="alert alert-info">Nenhuma avaliação ainda</div>';
            return;
        }

        reviewsContainer.innerHTML = reviews.map(review => `
            <div class="review-card">
                <div class="text-warning mb-2">
                    ${'★'.repeat(review.nota)}${'☆'.repeat(5 - review.nota)}
                    <small class="text-muted ms-2">
                        ${formatDate(review.data_avaliacao)}
                    </small>
                </div>
                <p>${review.comentario}</p>
                <small class="text-muted">Por ${review.usuario?.nome || 'Anônimo'}</small>
            </div>
        `).join('');
    }

    // Formata data no formato brasileiro
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // Envia a avaliação para a API
    async function submitReview() {
        if (!token) {
            alert('Você precisa estar logado para enviar uma avaliação.');
            return;
        }

        if (selectedRating === 0) {
            alert('Selecione uma nota.');
            return;
        }
        if (!commentInput.value.trim()) {
            alert('Escreva um comentário.');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/avaliacoes/${livroId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    nota: selectedRating,
                    comentario: commentInput.value.trim()
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.mensagem || 'Erro ao enviar avaliação');
            }

            alert('Avaliação enviada com sucesso!');
            // Reset form
            selectedRating = 0;
            updateStars();
            commentInput.value = '';

            // Atualiza lista
            loadReviews();
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!livroId) {
            showError('ID do livro não encontrado na URL.');
            return;
        }

        // Se o usuário não estiver logado, disable o envio
        if (!token) {
            document.querySelector('.card-body').innerHTML = `
                <div class="alert alert-warning">
                    Faça login para avaliar este livro.
                </div>
            `;
            return;
        }

        setupStarRating();
        loadReviews();

        submitBtn.addEventListener('click', submitReview);
    });
</script>
</body> </html>
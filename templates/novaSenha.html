<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <title>Nova Senha</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/login.css">
    <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">

    <!-- Fontes e Bootstrap -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</head>

<body>

    <header>
        <a id="logoHeader" href="index.html">
            <img class="logo-header" src="../static/img/logo.png" alt="Logo do site">
        </a>
    </header>

    <section class="tudo d-flex justify-content-center align-items-center flex-wrap p-4">
        <div>
            <img class="livro-1" src="../static/img/login-image.png" alt="Imagem de recuperação" style="max-width: 300px;">
        </div>

        <div class="formulario" style="min-width: 300px; max-width: 400px;">
            <h1 class="titulo">Nova Senha</h1>

            <form id="formNovaSenha" class="login" onsubmit="enviarNovaSenha(event)">
                <label class="coisa" for="nSenha">Sua Nova Senha:</label>
                <input placeholder="Insira sua nova senha" class="inserir form-control mb-2" type="password" id="nSenha" required>
                <input placeholder="Confirmar nova senha" class="inserir form-control mb-3" type="password" id="nSenha2" required>
            </form>

            <div class="final">
                <button type="submit" class="botao-login btn btn-primary w-100" form="formNovaSenha">Enviar</button>
                <p class="texto mt-3 text-center">Lembrou da senha? <a class="link" href="login.html">Voltar para login</a></p>
            </div>
        </div>
    </section>

    <script>
        const ipPython = "http://192.168.1.109:5000"; // Altere conforme seu servidor

        function getUsuarioId() {
            return localStorage.getItem("id_usuario");
        }

        async function enviarNovaSenha(event) {
            event.preventDefault();

            const novaSenha = document.getElementById('nSenha').value;
            const confirmarSenha = document.getElementById('nSenha2').value;
            const idUsuario = getUsuarioId();

            if (!idUsuario) {
                alert("ID de usuário não encontrado.");
                return;
            }

            if (novaSenha !== confirmarSenha) {
                alert("As senhas não coincidem.");
                return;
            }

            try {
                const response = await fetch(`${ipPython}/redefinir_senha/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nova_senha: novaSenha
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(`Erro: ${data.error}`);
                } else {
                    alert(data.message);
                    localStorage.removeItem("id_usuario"); // Limpa após uso
                    window.location.href = "login.html";
                }

            } catch (error) {
                console.error("Erro ao conectar com a API:", error);
                alert("Erro ao conectar com o servidor.");
            }
        }
    </script>
</body>

</html>
